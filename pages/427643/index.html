<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>架构设计 | Louis&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="http://media.luoxiaofeng.cn/blog/star.png">
    <meta name="description" content="专注后端技术">
    <meta name="keywords" content="后端博客,个人技术博客,技术文档,学习,Java,mysql,ES,Oracle,K8S,jenkins,docker,jvm,spring cloud,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.daeec4d3.css" as="style"><link rel="preload" href="/assets/js/app.78ede092.js" as="script"><link rel="preload" href="/assets/js/2.f39d1b19.js" as="script"><link rel="preload" href="/assets/js/45.f32e2a7c.js" as="script"><link rel="prefetch" href="/assets/js/10.5c972d7e.js"><link rel="prefetch" href="/assets/js/11.7e2a3186.js"><link rel="prefetch" href="/assets/js/12.704d47fe.js"><link rel="prefetch" href="/assets/js/13.8138b9f0.js"><link rel="prefetch" href="/assets/js/14.096585b2.js"><link rel="prefetch" href="/assets/js/15.2ea7dd45.js"><link rel="prefetch" href="/assets/js/16.617fa79c.js"><link rel="prefetch" href="/assets/js/17.baa7f295.js"><link rel="prefetch" href="/assets/js/18.bc6e3f2a.js"><link rel="prefetch" href="/assets/js/19.c60bf3bf.js"><link rel="prefetch" href="/assets/js/20.99f2b929.js"><link rel="prefetch" href="/assets/js/21.a4aea91a.js"><link rel="prefetch" href="/assets/js/22.eeb571c8.js"><link rel="prefetch" href="/assets/js/23.78401243.js"><link rel="prefetch" href="/assets/js/24.19799dbf.js"><link rel="prefetch" href="/assets/js/25.37a89fcb.js"><link rel="prefetch" href="/assets/js/26.e9f6391c.js"><link rel="prefetch" href="/assets/js/27.8ba3c7f4.js"><link rel="prefetch" href="/assets/js/28.56a598e1.js"><link rel="prefetch" href="/assets/js/29.ce88bfe3.js"><link rel="prefetch" href="/assets/js/3.347829c2.js"><link rel="prefetch" href="/assets/js/30.19bca574.js"><link rel="prefetch" href="/assets/js/31.bbb78c9c.js"><link rel="prefetch" href="/assets/js/32.bcac7637.js"><link rel="prefetch" href="/assets/js/33.4a6bb74c.js"><link rel="prefetch" href="/assets/js/34.a5175bc0.js"><link rel="prefetch" href="/assets/js/35.df93bce0.js"><link rel="prefetch" href="/assets/js/36.ba98c8cd.js"><link rel="prefetch" href="/assets/js/37.15426157.js"><link rel="prefetch" href="/assets/js/38.7dfdb586.js"><link rel="prefetch" href="/assets/js/39.799ea50e.js"><link rel="prefetch" href="/assets/js/4.bd92418e.js"><link rel="prefetch" href="/assets/js/40.7d304a58.js"><link rel="prefetch" href="/assets/js/41.4f267901.js"><link rel="prefetch" href="/assets/js/42.6d8298d3.js"><link rel="prefetch" href="/assets/js/43.0283af03.js"><link rel="prefetch" href="/assets/js/44.579cf258.js"><link rel="prefetch" href="/assets/js/46.880f4527.js"><link rel="prefetch" href="/assets/js/47.3132fd72.js"><link rel="prefetch" href="/assets/js/48.1ab83cae.js"><link rel="prefetch" href="/assets/js/49.17233d6b.js"><link rel="prefetch" href="/assets/js/5.2d40d187.js"><link rel="prefetch" href="/assets/js/50.715c8235.js"><link rel="prefetch" href="/assets/js/51.60499077.js"><link rel="prefetch" href="/assets/js/52.985814b9.js"><link rel="prefetch" href="/assets/js/53.cdfe6fbd.js"><link rel="prefetch" href="/assets/js/54.2f036c47.js"><link rel="prefetch" href="/assets/js/55.ddaed78c.js"><link rel="prefetch" href="/assets/js/56.294bd3d7.js"><link rel="prefetch" href="/assets/js/57.a2e4f259.js"><link rel="prefetch" href="/assets/js/58.ed113fdb.js"><link rel="prefetch" href="/assets/js/59.e86a8e3f.js"><link rel="prefetch" href="/assets/js/6.302fb005.js"><link rel="prefetch" href="/assets/js/60.96d5ed6d.js"><link rel="prefetch" href="/assets/js/61.8929ac7f.js"><link rel="prefetch" href="/assets/js/62.325f88d8.js"><link rel="prefetch" href="/assets/js/63.78255037.js"><link rel="prefetch" href="/assets/js/64.a016537e.js"><link rel="prefetch" href="/assets/js/65.cabb3053.js"><link rel="prefetch" href="/assets/js/66.a23325f5.js"><link rel="prefetch" href="/assets/js/67.af383ab9.js"><link rel="prefetch" href="/assets/js/68.3abd0620.js"><link rel="prefetch" href="/assets/js/69.c96f585d.js"><link rel="prefetch" href="/assets/js/7.a6e5a0c4.js"><link rel="prefetch" href="/assets/js/70.40bd8334.js"><link rel="prefetch" href="/assets/js/71.65ca6ebf.js"><link rel="prefetch" href="/assets/js/72.b3df0ff9.js"><link rel="prefetch" href="/assets/js/73.fb5cd2d0.js"><link rel="prefetch" href="/assets/js/74.5da3ef52.js"><link rel="prefetch" href="/assets/js/75.fcee8cb7.js"><link rel="prefetch" href="/assets/js/76.31fcdf4b.js"><link rel="prefetch" href="/assets/js/77.7ffbc0b3.js"><link rel="prefetch" href="/assets/js/78.c6d54f3c.js"><link rel="prefetch" href="/assets/js/79.cd6e1a7c.js"><link rel="prefetch" href="/assets/js/8.40a90d8d.js"><link rel="prefetch" href="/assets/js/80.aef9fad9.js"><link rel="prefetch" href="/assets/js/81.87a224d2.js"><link rel="prefetch" href="/assets/js/82.40c4ec64.js"><link rel="prefetch" href="/assets/js/83.0f5718dc.js"><link rel="prefetch" href="/assets/js/84.0a3fb58d.js"><link rel="prefetch" href="/assets/js/85.2d2a1e21.js"><link rel="prefetch" href="/assets/js/86.37906477.js"><link rel="prefetch" href="/assets/js/87.1e123481.js"><link rel="prefetch" href="/assets/js/88.b1284090.js"><link rel="prefetch" href="/assets/js/89.352f857e.js"><link rel="prefetch" href="/assets/js/9.854ec9c5.js"><link rel="prefetch" href="/assets/js/90.82803ff4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.daeec4d3.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="http://media.luoxiaofeng.cn/blog/star.png" alt="Louis's Blog" class="logo"> <span class="site-name can-hide">Louis's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/8611ff/" class="nav-link">学习笔记</a></div><div class="nav-item"><a href="/pages/f811c1/" class="nav-link">技术应用</a></div><div class="nav-item"><a href="/pages/bcce0d/" class="nav-link">流程规范</a></div><div class="nav-item"><a href="/friends/" class="nav-link">更多</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="http://media.luoxiaofeng.cn/blog/lxf.jpeg"> <div class="blogger-info"><h3>Louis</h3> <span></span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/8611ff/" class="nav-link">学习笔记</a></div><div class="nav-item"><a href="/pages/f811c1/" class="nav-link">技术应用</a></div><div class="nav-item"><a href="/pages/bcce0d/" class="nav-link">流程规范</a></div><div class="nav-item"><a href="/friends/" class="nav-link">更多</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JVM</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>消息中间件</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>持久化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>系统架构</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/427643/" aria-current="page" class="active sidebar-link">架构设计</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/427643/#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header level2"><a href="/pages/427643/#_1-高性能" class="sidebar-link">1 高性能</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/427643/#_1-1-服务拆分" class="sidebar-link">1.1 服务拆分</a></li><li class="sidebar-sub-header level3"><a href="/pages/427643/#_1-2-缓存" class="sidebar-link">1.2 缓存</a></li><li class="sidebar-sub-header level3"><a href="/pages/427643/#_1-3-消息队列解耦削峰" class="sidebar-link">1.3 消息队列解耦削峰</a></li><li class="sidebar-sub-header level3"><a href="/pages/427643/#_1-4-负载均衡" class="sidebar-link">1.4 负载均衡</a></li><li class="sidebar-sub-header level3"><a href="/pages/427643/#_1-5-读写分离-分库分表" class="sidebar-link">1.5 读写分离&amp;分库分表</a></li><li class="sidebar-sub-header level4"><a href="/pages/427643/#_1-5-1-读写分离会带来的问题" class="sidebar-link">1.5.1 读写分离会带来的问题</a></li><li class="sidebar-sub-header level4"><a href="/pages/427643/#_1-5-2-主从复制原理" class="sidebar-link">1.5.2 主从复制原理</a></li><li class="sidebar-sub-header level4"><a href="/pages/427643/#_1-5-3-分库分表带来的问题" class="sidebar-link">1.5.3 分库分表带来的问题</a></li><li class="sidebar-sub-header level4"><a href="/pages/427643/#_1-5-4-分库分表后-数据怎么迁移" class="sidebar-link">1.5.4 分库分表后，数据怎么迁移？</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/427643/#_2-高可用" class="sidebar-link">2 高可用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/427643/#_2-1-衡量高可用" class="sidebar-link">2.1 衡量高可用</a></li><li class="sidebar-sub-header level3"><a href="/pages/427643/#_2-2-硬件层面保证高可用" class="sidebar-link">2.2 硬件层面保证高可用</a></li><li class="sidebar-sub-header level4"><a href="/pages/427643/#_2-2-1-灾备设计" class="sidebar-link">2.2.1 灾备设计</a></li><li class="sidebar-sub-header level4"><a href="/pages/427643/#_2-2-2-异地多活" class="sidebar-link">2.2.2 异地多活</a></li><li class="sidebar-sub-header level4"><a href="/pages/427643/#_2-2-3-灾备到异地多活的演变过程" class="sidebar-link">2.2.3 灾备到异地多活的演变过程</a></li><li class="sidebar-sub-header level3"><a href="/pages/427643/#_2-3-系统及代码层面保证高可用" class="sidebar-link">2.3 系统及代码层面保证高可用</a></li><li class="sidebar-sub-header level4"><a href="/pages/427643/#_2-3-1-集群" class="sidebar-link">2.3.1 集群</a></li><li class="sidebar-sub-header level4"><a href="/pages/427643/#_2-3-2-版本可回滚" class="sidebar-link">2.3.2 版本可回滚</a></li><li class="sidebar-sub-header level4"><a href="/pages/427643/#_2-3-3-超时重试" class="sidebar-link">2.3.3 超时重试</a></li><li class="sidebar-sub-header level4"><a href="/pages/427643/#_2-3-4-降级" class="sidebar-link">2.3.4 降级</a></li><li class="sidebar-sub-header level4"><a href="/pages/427643/#_2-3-5-熔断" class="sidebar-link">2.3.5 熔断</a></li><li class="sidebar-sub-header level4"><a href="/pages/427643/#_2-3-6-限流" class="sidebar-link">2.3.6 限流</a></li><li class="sidebar-sub-header level5"><a href="/pages/427643/#_2-3-6-1-常见限流方案" class="sidebar-link">2.3.6.1 常见限流方案</a></li><li class="sidebar-sub-header level6"><a href="/pages/427643/#_1-计数器法" class="sidebar-link">1.计数器法</a></li><li class="sidebar-sub-header level6"><a href="/pages/427643/#_2-漏桶算法" class="sidebar-link">2.漏桶算法</a></li><li class="sidebar-sub-header level6"><a href="/pages/427643/#_3-令牌桶算法-推荐" class="sidebar-link">3.令牌桶算法（推荐）</a></li><li class="sidebar-sub-header level5"><a href="/pages/427643/#_2-3-6-2-guava限流工具类" class="sidebar-link">2.3.6.2 Guava限流工具类</a></li><li class="sidebar-sub-header level6"><a href="/pages/427643/#_1-说明" class="sidebar-link">1.说明</a></li><li class="sidebar-sub-header level6"><a href="/pages/427643/#_2-代码示例" class="sidebar-link">2.代码示例</a></li></ul></li></ul></li><li><a href="/pages/c0fe60/" class="sidebar-link">分布式</a></li><li><a href="/pages/68d51a/" class="sidebar-link">机器评估</a></li><li><a href="/pages/694a95/" class="sidebar-link">TP50、TP90、TP99</a></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1baff76c><div class="articleInfo" data-v-1baff76c><ul class="breadcrumbs" data-v-1baff76c><li data-v-1baff76c><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-1baff76c></a></li> <li data-v-1baff76c><a href="/categories/?category=%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0" title="分类" data-v-1baff76c>学习笔记</a></li><li data-v-1baff76c><a href="/categories/?category=%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84" title="分类" data-v-1baff76c>系统架构</a></li></ul> <div class="info" data-v-1baff76c><div title="作者" class="author iconfont icon-touxiang" data-v-1baff76c><a href="javascript:;" data-v-1baff76c>luoxiaofeng</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1baff76c><a href="javascript:;" data-v-1baff76c>2022-04-28</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">架构设计<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="系统架构设计"><a href="#系统架构设计" class="header-anchor">#</a> 系统架构设计</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>一个好的软件架构，应该遵循<strong>高性能、高可用、易扩展</strong> 3 大原则，其中「高可用」在系统规模变得越来越大时，变得尤为重要。</p> <h2 id="_1-高性能"><a href="#_1-高性能" class="header-anchor">#</a> 1 高性能</h2> <h3 id="_1-1-服务拆分"><a href="#_1-1-服务拆分" class="header-anchor">#</a> 1.1 服务拆分</h3> <p>按功能纬度、读写维度（如yl-nwm-waybillouter-api）</p> <h3 id="_1-2-缓存"><a href="#_1-2-缓存" class="header-anchor">#</a> 1.2 缓存</h3> <p>浏览器缓存、cdn缓存、应用层缓存（redis、内存缓存等）</p> <h3 id="_1-3-消息队列解耦削峰"><a href="#_1-3-消息队列解耦削峰" class="header-anchor">#</a> 1.3 消息队列解耦削峰</h3> <p>运单收发到派签消息通过RabbitMQ发送</p> <h3 id="_1-4-负载均衡"><a href="#_1-4-负载均衡" class="header-anchor">#</a> 1.4 负载均衡</h3> <p>常见的负载均衡系统包括3种：</p> <p><strong>DNS负载均衡</strong>：一般用来实现地理级别的均衡。</p> <p><strong>硬件负载均衡</strong>：通过独立的硬件设备，比如F5，实现负载均衡功能（硬件价格一般较贵）。</p> <p><strong>软件负载均衡</strong>：通过软件的方式，比如Nginx，实现负载均衡功能。</p> <h3 id="_1-5-读写分离-分库分表"><a href="#_1-5-读写分离-分库分表" class="header-anchor">#</a> 1.5 读写分离&amp;分库分表</h3> <h4 id="_1-5-1-读写分离会带来的问题"><a href="#_1-5-1-读写分离会带来的问题" class="header-anchor">#</a> 1.5.1 读写分离会带来的问题</h4> <p>主库和从库数据同步存在延迟，写完数据马上读取时可能读不到最新数据。</p> <p>解决方法：</p> <p><strong>1.强制将读请求路由到主库处理</strong></p> <p>比如 Sharding-JDBC，可以通过 HintManager 分片键值管理器强制使用主库。</p> <img src="http://media.luoxiaofeng.cn/blog/img/ce763328ae5e186b847168672f356bf9.png" width="70%" class="imgcss"> <p><strong>2.延迟读取</strong></p> <p>这种方式不太合适 ...</p> <h4 id="_1-5-2-主从复制原理"><a href="#_1-5-2-主从复制原理" class="header-anchor">#</a> 1.5.2 主从复制原理</h4> <p>1.主库将数据变化写入binlog。</p> <p>2.从库创建一个I/O线程向主库请求更新的binlog。</p> <p>3.主库创建一个线程发送binlog，从库I/O线程负责接收。</p> <p>4.从库I/O线程接收的binlog写入到relay log中。</p> <p>5.从库的SQL线程读取relay log同步数据到本地（也就是再执行一遍SQL）。</p> <h4 id="_1-5-3-分库分表带来的问题"><a href="#_1-5-3-分库分表带来的问题" class="header-anchor">#</a> 1.5.3 分库分表带来的问题</h4> <p>1.join操作：表分布到不同数据库，导致无法进行连表操作。</p> <p>2.事务问题：操作不同数据库的表，自带的事务无法支持。</p> <p>3.分布式id：自增主键等方式无法使用，需引入分布式ID。</p> <h4 id="_1-5-4-分库分表后-数据怎么迁移"><a href="#_1-5-4-分库分表后-数据怎么迁移" class="header-anchor">#</a> 1.5.4 分库分表后，数据怎么迁移？</h4> <p>使用数据库同步工具 Canal 做增量数据迁移（还是依赖 binlog，开发和维护成本较低）。</p> <h2 id="_2-高可用"><a href="#_2-高可用" class="header-anchor">#</a> 2 高可用</h2> <h3 id="_2-1-衡量高可用"><a href="#_2-1-衡量高可用" class="header-anchor">#</a> 2.1 衡量高可用</h3> <p>高可用通常通常用两个指标来衡量。</p> <p><strong>平均故障时间间隔</strong>：表示两次故障的时间间隔，也就是系统正常运行平均时间。这个时间越长越稳定。</p> <p><strong>故障恢复时间</strong>：系统发生故障后的恢复时间。这个时间越短，对用户影响越小。</p> <p>可用性跟这两个指标之间的关系为：</p> <p><strong>可用性</strong> = <strong>平均故障时间间隔</strong> / (<strong>平均故障时间间隔</strong> + <strong>故障恢复时间</strong>) * 100%</p> <p>这个公式得出的结果是一个「比例」，通常我们会用**「N 个 9」**来描述一个系统的可用性。</p> <img src="http://media.luoxiaofeng.cn/blog/img/cbce53612865bf8cbe998c7c7b7f9c23.png" width="70%" class="imgcss"> <h3 id="_2-2-硬件层面保证高可用"><a href="#_2-2-硬件层面保证高可用" class="header-anchor">#</a> 2.2 硬件层面保证高可用</h3> <h4 id="_2-2-1-灾备设计"><a href="#_2-2-1-灾备设计" class="header-anchor">#</a> 2.2.1 灾备设计</h4> <p>灾备设计 = 容灾 + 备份</p> <p><strong>容灾</strong>：建立两个相同的系统。当其中一个系统出问题时，可以直接切换另一个系统使用。</p> <p><strong>备份</strong>：将系统产生的重要数据进行备份。</p> <h4 id="_2-2-2-异地多活"><a href="#_2-2-2-异地多活" class="header-anchor">#</a> 2.2.2 异地多活</h4> <p>将服务部署到异地，并且多地服务能同时对外提供服务。</p> <p>异地多活主要应对突发情况，如火灾、地震、人为灾害等。</p> <h4 id="_2-2-3-灾备到异地多活的演变过程"><a href="#_2-2-3-灾备到异地多活的演变过程" class="header-anchor">#</a> 2.2.3 灾备到异地多活的演变过程</h4> <p><strong>同城灾备</strong>分为「冷备」和「热备」，「冷备」只备份数据，不提供服务。「热备」实时同步数据，做好随时切换的准备。</p> <img src="http://media.luoxiaofeng.cn/blog/img/1947bba189869dbcfdbc46d9f939cf2e.png" width="50%" class="imgcss"> <p><strong>同城双活</strong>比同城灾备的优势在于，两个机房都可以接入「读写」流量。提高可用性的同时也提高系统性能。（由于机房部署同一城市，可不考虑网络延迟问题。<strong>光纤传输的速度大概为 300km/ms</strong>）</p> <img src="http://media.luoxiaofeng.cn/blog/img/a2eb2e47789c36c7d626c39c9b51b603.png" width="50%" class="imgcss"> <p><strong>两地三中心</strong>是在同城双活基础上再部署一个异地机房做「灾备」，用来抵御「城市」级别的灾害。但启用灾备机房需要耗费一定时间。（两地是指两个城市，三中心是指三个机房）</p> <img src="http://media.luoxiaofeng.cn/blog/img/1c2c0bc9af033cb6b1ceaef2e89d5a0a.png" width="50%" class="imgcss"> <p><strong>异地双活</strong>才是抵御「城市」级别灾害的更好方案。异地两个机房同时提供服务，有故障随时切换，可用性高。但是实现也很复杂。异地双活要两个机房都可以读写（不同城市的两个机房如果只有一个机房数据库做主库，会导致另一个只读的机房查数据延迟很高）。MySQL本身提供了双主架构，支持双向复制数据，但是像redis、mq等都不支持双向同步数据，需要另外开发。</p> <img src="http://media.luoxiaofeng.cn/blog/img/dabe61c01c666480910350e9c98272f4.png" width="50%" class="imgcss"> <p>此外，还需要在业务上将数据区分开，保证指定数据操作指定机房，避免各种脏数据的产生。这样，需要在接入层之上再部署一个**「路由层」（通常部署在云服务器上）**，自己可以配置不同路由规则，将用户分流到不同的机房内。</p> <img src="http://media.luoxiaofeng.cn/blog/img/f35a987de7f72f0f1f47ba25092d96e6.png" width="50%" class="imgcss"> <p><strong>异地多活</strong>是在异地双活的基础上扩展多个机房，这样不仅保证了高可用，还保证了高性能，可以应对更大规模的流量压力。是实现高可用的最终方案。</p> <img src="http://media.luoxiaofeng.cn/blog/img/badde66fe5079933863b9ff1c3695dfe.png" width="50%" class="imgcss"> <p>这种星状的方案必须要设立一个**「中心机房」**，任意机房写入数据后要先同步到中心机房，再由中心机房同步到其他机房。中心机房的稳定性要求比较高，不过中心机房如果发生故障的话，可以把任意一个机房提升为中心机房，继续按照之前的架构提供服务。</p> <h3 id="_2-3-系统及代码层面保证高可用"><a href="#_2-3-系统及代码层面保证高可用" class="header-anchor">#</a> 2.3 系统及代码层面保证高可用</h3> <h4 id="_2-3-1-集群"><a href="#_2-3-1-集群" class="header-anchor">#</a> 2.3.1 集群</h4> <p>使用集群，减少单点故障。</p> <h4 id="_2-3-2-版本可回滚"><a href="#_2-3-2-版本可回滚" class="header-anchor">#</a> 2.3.2 版本可回滚</h4> <p>应用部署支持版本回滚。</p> <p>数据库脚本也需要有回滚脚本。</p> <h4 id="_2-3-3-超时重试"><a href="#_2-3-3-超时重试" class="header-anchor">#</a> 2.3.3 超时重试</h4> <p>重试次数一般为3次。</p> <h4 id="_2-3-4-降级"><a href="#_2-3-4-降级" class="header-anchor">#</a> 2.3.4 降级</h4> <p>同步改异步（如同步导出通过配置调整成异步导出）。</p> <p>直接读缓存（关键功能本来查库的调整成临时查缓存）。</p> <h4 id="_2-3-5-熔断"><a href="#_2-3-5-熔断" class="header-anchor">#</a> 2.3.5 熔断</h4> <p>熔断和降级是两个容易混淆的概念，这两者的含义并不一样。</p> <p>降级针对的是自身系统的故障，而熔断是要应对其他系统的故障。</p> <h4 id="_2-3-6-限流"><a href="#_2-3-6-限流" class="header-anchor">#</a> 2.3.6 限流</h4> <h5 id="_2-3-6-1-常见限流方案"><a href="#_2-3-6-1-常见限流方案" class="header-anchor">#</a> 2.3.6.1 常见限流方案</h5> <h6 id="_1-计数器法"><a href="#_1-计数器法" class="header-anchor">#</a> 1.计数器法</h6> <p><strong>原理</strong>：在单位时间段内，对请求数进行计数，如果数量超过了单位时间的限制，则执行限流策略，当单位时间结束后，计数器清零，这个过程周而复始，就是计数器法。</p> <p><strong>缺点</strong>：不能均衡限流，在一个单位时间的末尾和下一个单位时间的开始，很可能会有两个访问的峰值，导致系统崩溃。</p> <p><strong>改进方式</strong>：可以通过减小单位时间来提高精度。</p> <h6 id="_2-漏桶算法"><a href="#_2-漏桶算法" class="header-anchor">#</a> 2.漏桶算法</h6> <p><strong>原理</strong>：假设有一个水桶，水桶有一定的容量，所有请求不论速度都会注入到水桶中，然后水桶以一个恒定的速度向外将请求放出，当水桶满了的时候，新的请求被丢弃。</p> <p><strong>优点</strong>：可以平滑请求，削减峰值。</p> <p><strong>缺点</strong>：瓶颈会在漏出的速度，可能会拖慢整个系统，且不能有效地利用系统的资源。</p> <img src="http://media.luoxiaofeng.cn/blog/img/d0f56213bda1af35d6aaba121ad6e42a.png" width="30%" class="imgcss"> <h6 id="_3-令牌桶算法-推荐"><a href="#_3-令牌桶算法-推荐" class="header-anchor">#</a> 3.令牌桶算法（推荐）</h6> <p><strong>原理</strong>：有一个令牌桶，单位时间内令牌会以恒定的数量（即令牌的加入速度）加入到令牌桶中，所有请求都需要获取令牌才可正常访问。当令牌桶中没有令牌可取的时候，则拒绝请求。</p> <p><strong>优点</strong>：相比漏桶算法，令牌桶算法允许一定的突发流量，但是又不会让突发流量超过我们给定的限制（单位时间窗口内的令牌数）。即限制了我们所说的 QPS(每秒查询率)。</p> <img src="http://media.luoxiaofeng.cn/blog/img/fe31522d82c8142053e2bf86d71d8741.png" width="50%" class="imgcss"> <h5 id="_2-3-6-2-guava限流工具类"><a href="#_2-3-6-2-guava限流工具类" class="header-anchor">#</a> 2.3.6.2 Guava限流工具类</h5> <h6 id="_1-说明"><a href="#_1-说明" class="header-anchor">#</a> 1.说明</h6> <p>Google开源工具包Guava提供了限流工具类RateLimiter，基于令牌桶算法实现。</p> <p>常用方法：</p> <p><strong>create</strong>(Double permitsPerSecond) 方法根据参数（令牌:单位时间（1s））比例为令牌生成速率。<br> <strong>tryAcquire()</strong> 方法尝试获取一个令牌，立即返回true/false，不阻塞，重载方法具备设置获取令牌个数、获取最大等待时间等参数。<br> <strong>acquire()</strong> 方法与tryAcquire类似，但是会阻塞，尝试获取一个令牌，没有时则阻塞直到获取成功。</p> <p>可能有人在想既然是令牌桶算法，应该有个类似定时器的东东来持续往桶放令牌才对啊，我刚开始也是这么想的，看了代码觉得自己还是太嫩了，如果开启一个定时器无可厚非，但如果系统需要N个不同速率的桶来针对不同的场景或用户，就会极大的消耗系统资源。</p> <p>RateLimiter用了一种类似于延迟计算的方法，把桶里令牌数量的计算放在下一个请求中计算，即桶里的令牌数 storedPermits 不是实时更新的，而是等到下一个请求过来时才更新。</p> <h6 id="_2-代码示例"><a href="#_2-代码示例" class="header-anchor">#</a> 2.代码示例</h6> <img src="http://media.luoxiaofeng.cn/blog/img/5802889ae03a3bc9ef7e678c7dffeb9f.png" width="60%" class="imgcss"> <p>需关注好服务监控指标，如qps，响应时间，tomcat线程信息等（acceptcount,maxConnections）</p></div></div>  <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84" title="标签">#系统架构</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/19/2022, 10:07:10 PM</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/97f034/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">代理</div></a> <a href="/pages/c0fe60/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">分布式</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/97f034/" class="prev">代理</a></span> <span class="next"><a href="/pages/c0fe60/">分布式</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/c177c7/"><div>
            MySQL安装
            <!----></div></a> <span class="date">05-19</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/182790/"><div>
            Kafka Manager安装
            <!----></div></a> <span class="date">05-17</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/b4a369/"><div>
            Kafka集群搭建
            <!----></div></a> <span class="date">05-16</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2022
    <span>Louis | <a href="https://beian.miit.gov.cn" target="_blank">粤ICP备2022060093号-1</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><!----><div class="RibbonAnimation"></div></div></div>
    <script src="/assets/js/app.78ede092.js" defer></script><script src="/assets/js/2.f39d1b19.js" defer></script><script src="/assets/js/45.f32e2a7c.js" defer></script>
  </body>
</html>
